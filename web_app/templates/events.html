{% extends "base.html" %}

{% block title %}Events - Asia Society Speaker Database{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Browse Events</h1>
        <p class="text-gray-600">Explore Asia Society events from around the world</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Location Filter -->
            <div>
                <label for="location-filter" class="block text-sm font-medium text-gray-700 mb-2">
                    Filter by Location
                </label>
                <select id="location-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Locations</option>
                    <!-- Populated dynamically -->
                </select>
            </div>

            <!-- Results Count -->
            <div class="flex items-end">
                <div class="text-sm text-gray-600">
                    <span id="results-count" class="font-semibold">0</span> events found
                </div>
            </div>

            <!-- Load More -->
            <div class="flex items-end justify-end">
                <button id="load-more-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Load More
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="text-gray-600 mt-4">Loading events...</p>
    </div>

    <!-- Events Grid -->
    <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Populated dynamically -->
    </div>

    <!-- No Results -->
    <div id="no-results" class="text-center py-12 hidden">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="text-gray-600 mt-4">No events found</p>
    </div>
</div>

<style>
.event-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.event-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentOffset = 0;
const limit = 50;
let currentLocation = '';
let allLocations = [];
let hasMore = true;

// Load events on page load
document.addEventListener('DOMContentLoaded', () => {
    loadEvents(true);
});

// Location filter change
document.getElementById('location-filter').addEventListener('change', (e) => {
    currentLocation = e.target.value;
    currentOffset = 0;
    loadEvents(true);
});

// Load more button
document.getElementById('load-more-btn').addEventListener('click', () => {
    loadEvents(false);
});

async function loadEvents(reset = false) {
    if (reset) {
        currentOffset = 0;
        document.getElementById('events-container').innerHTML = '';
        hasMore = true;
    }

    const loading = document.getElementById('loading');
    const container = document.getElementById('events-container');
    const noResults = document.getElementById('no-results');
    const loadMoreBtn = document.getElementById('load-more-btn');

    loading.classList.remove('hidden');
    loadMoreBtn.disabled = true;

    try {
        let url = `/api/events?limit=${limit}&offset=${currentOffset}`;
        if (currentLocation) {
            url += `&location=${encodeURIComponent(currentLocation)}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            // Populate location filter on first load
            if (currentOffset === 0 && data.locations) {
                populateLocationFilter(data.locations);
            }

            // Update results count
            const totalShown = currentOffset + data.events.length;
            document.getElementById('results-count').textContent = totalShown;

            // Check if there are more results
            hasMore = data.events.length === limit;
            loadMoreBtn.disabled = !hasMore;
            if (!hasMore) {
                loadMoreBtn.textContent = 'No More Events';
            }

            // Render events
            if (data.events.length === 0 && currentOffset === 0) {
                noResults.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                container.classList.remove('hidden');
                renderEvents(data.events);
                currentOffset += data.events.length;
            }
        } else {
            alert('Error loading events: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load events. Please try again.');
    } finally {
        loading.classList.add('hidden');
        if (hasMore) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'Load More';
        }
    }
}

function populateLocationFilter(locations) {
    const select = document.getElementById('location-filter');
    const currentValue = select.value;

    // Keep "All Locations" option, add new locations
    const options = locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
    select.innerHTML = '<option value="">All Locations</option>' + options;

    // Restore previous selection if it exists
    if (currentValue && locations.includes(currentValue)) {
        select.value = currentValue;
    }
}

function renderEvents(events) {
    const container = document.getElementById('events-container');

    events.forEach(event => {
        const card = createEventCard(event);
        container.appendChild(card);
    });
}

function createEventCard(event) {
    const div = document.createElement('div');
    div.className = 'event-card bg-white rounded-lg shadow-sm border p-6 hover:shadow-md cursor-pointer';
    div.onclick = () => window.location.href = `/event/${event.event_id}`;

    // Format date
    const dateDisplay = event.event_date || 'Date TBA';

    // Speaker count badge
    const speakerBadge = event.speaker_count > 0
        ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
             ${event.speaker_count} speaker${event.speaker_count !== 1 ? 's' : ''}
           </span>`
        : '';

    div.innerHTML = `
        <div class="mb-3">
            <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
                ${escapeHtml(event.title || 'Untitled Event')}
            </h3>
            <div class="flex items-center space-x-3 text-sm text-gray-600">
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    ${escapeHtml(dateDisplay)}
                </div>
                ${event.location ? `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    ${escapeHtml(event.location)}
                </div>
                ` : ''}
            </div>
        </div>
        <div class="flex items-center justify-between">
            ${speakerBadge}
            <span class="text-blue-600 text-sm font-medium">View Details â†’</span>
        </div>
    `;

    return div;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
