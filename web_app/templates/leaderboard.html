{% extends "base.html" %}

{% block title %}Speaker Leaderboard - Asia Society Speaker Database{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Speaker Leaderboard</h1>
        <p class="text-gray-600">Most active speakers at Asia Society events</p>
    </div>

    <!-- Time Filter -->
    <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="time-filter" class="block text-sm font-medium text-gray-700 mb-2">
                    Time Period
                </label>
                <select id="time-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="12">Last 12 Months</option>
                    <option value="6">Last 6 Months</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            <div class="flex items-end">
                <div class="text-sm text-gray-600">
                    Showing top <span id="speaker-count" class="font-semibold">10</span> speakers
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="text-gray-600 mt-4">Loading leaderboard...</p>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard-container" class="space-y-4">
        <!-- Populated dynamically -->
    </div>

    <!-- No Results -->
    <div id="no-results" class="text-center py-12 hidden">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <p class="text-gray-600 mt-4">No speakers found</p>
    </div>
</div>

<style>
.speaker-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.speaker-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 1.25rem;
}
.rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #854d0e; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #3f3f46; }
.rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e89b5e 100%); color: #44403c; }
.rank-other { background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%); color: #6b7280; }
</style>
{% endblock %}

{% block scripts %}
<script>
let currentTimeframe = '12';

// Load leaderboard on page load
document.addEventListener('DOMContentLoaded', () => {
    loadLeaderboard();
});

// Time filter change
document.getElementById('time-filter').addEventListener('change', (e) => {
    currentTimeframe = e.target.value;
    loadLeaderboard();
});

async function loadLeaderboard() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('leaderboard-container');
    const noResults = document.getElementById('no-results');

    loading.classList.remove('hidden');
    container.innerHTML = '';

    try {
        const url = `/api/leaderboard?limit=10&months=${currentTimeframe}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            document.getElementById('speaker-count').textContent = data.count;

            if (data.speakers.length === 0) {
                noResults.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                container.classList.remove('hidden');
                renderSpeakers(data.speakers, data.timeframe);
            }
        } else {
            alert('Error loading leaderboard: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load leaderboard. Please try again.');
    } finally {
        loading.classList.add('hidden');
    }
}

function renderSpeakers(speakers, timeframe) {
    const container = document.getElementById('leaderboard-container');

    speakers.forEach(speaker => {
        const card = createSpeakerCard(speaker, timeframe);
        container.appendChild(card);
    });
}

function createSpeakerCard(speaker, timeframe) {
    const div = document.createElement('div');
    div.className = 'speaker-card bg-white rounded-lg shadow-sm border p-6 hover:shadow-md cursor-pointer';
    div.onclick = () => window.location.href = `/speaker/${speaker.speaker_id}`;

    // Rank badge styling
    let rankClass = 'rank-other';
    if (speaker.rank === 1) rankClass = 'rank-1';
    else if (speaker.rank === 2) rankClass = 'rank-2';
    else if (speaker.rank === 3) rankClass = 'rank-3';

    // Format locations
    const locationDisplay = speaker.locations && speaker.locations.length > 0
        ? speaker.locations.slice(0, 3).join(', ')
        : 'Various locations';

    const moreLocations = speaker.location_count > 3
        ? ` +${speaker.location_count - 3} more`
        : '';

    // Tags
    const tagsHtml = speaker.tags && speaker.tags.length > 0
        ? speaker.tags.slice(0, 3).map(tag =>
            `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                ${escapeHtml(tag)}
            </span>`
          ).join('')
        : '';

    div.innerHTML = `
        <div class="flex items-start space-x-6">
            <!-- Rank Badge -->
            <div class="rank-badge ${rankClass} flex-shrink-0">
                #${speaker.rank}
            </div>

            <!-- Speaker Info -->
            <div class="flex-grow min-w-0">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-grow min-w-0">
                        <h3 class="text-xl font-semibold text-gray-900 mb-1 truncate">
                            ${escapeHtml(speaker.name)}
                        </h3>
                        <p class="text-gray-600 text-sm truncate">
                            ${escapeHtml(speaker.affiliation || 'Independent')}
                        </p>
                    </div>

                    <!-- Event Count Badge -->
                    <div class="ml-4 flex-shrink-0">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600">
                                ${speaker.event_count}
                            </div>
                            <div class="text-xs text-gray-500">
                                event${speaker.event_count !== 1 ? 's' : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata Row -->
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600 mb-3">
                    ${speaker.last_event ? `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Last event: ${escapeHtml(speaker.last_event)}
                    </div>
                    ` : ''}

                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        ${escapeHtml(locationDisplay)}${moreLocations}
                    </div>
                </div>

                <!-- Expertise Tags -->
                ${tagsHtml ? `
                <div class="flex flex-wrap gap-2">
                    ${tagsHtml}
                </div>
                ` : ''}
            </div>
        </div>
    `;

    return div;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
